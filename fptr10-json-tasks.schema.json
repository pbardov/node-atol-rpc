{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/atol-v10-json-task.schema.json",
  "title": "ATOL Driver v10 — JSON Tasks (community-built schema)",
  "description": "Черновая унифицированная JSON Schema для JSON-заданий драйвера АТОЛ v10. Основано на открытых разделах документации и релиз-нотах. Поля помеченные as-is или optional могут отличаться в зависимости от версии драйвера/ККТ. Эта версия включает задачи по чекам, сменам, отчетам, запросам к ФН/ОФД, маркировке (в т.ч. getMarkingCodeValidationStatus), сервисным операциям и статусам.",
  "type": "object",
  "additionalProperties": false,
  "required": ["type"],
  "properties": {
    "type": {
      "type": "string",
      "description": "Тип JSON-задания (операция)",
      "enum": [
        "continuePrint",
        "openShift",
        "closeShift",
        "xReport",
        "zReport",
        "sellReceipt",
        "refundReceipt",
        "buyReceipt",
        "returnBuyReceipt",
        "sellCorrectionReceipt",
        "refundSellCorrectionReceipt",
        "buyCorrectionReceipt",
        "refundBuyCorrectionReceipt",
        "cashIn",
        "cashOut",
        "printNonFiscal",
        "ofdExchangeStatus",
        "getDeviceInfo",
        "getDriverInfo",
        "getShiftTotals",
        "getDepartmentSum",
        "getFnInfo",
        "getFnDocument",
        "getFiscalDocumentResult",
        "reportFnRegistrations",
        "beginMarkingCodeValidation",
        "getMarkingCodeValidationStatus",
        "cancelMarkingCodeValidation",
        "checkImcWorkState",
        "pingIsmServer",
        "getIsmPingResult"
      ]
    },
    "timeout": {
      "type": "integer",
      "minimum": 0,
      "description": "Таймаут выполнения задания в миллисекундах (опционально)."
    },
    "params": {
      "type": "object",
      "description": "Параметры задания; форма зависит от type.",
      "additionalProperties": false
    }
  },
  "allOf": [
    { "if": { "properties": { "type": { "const": "continuePrint" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/ContinuePrintParams" } } } },
    { "if": { "properties": { "type": { "const": "openShift" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/OpenShiftParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "closeShift" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/CloseShiftParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "xReport" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/EmptyParams" } } } },
    { "if": { "properties": { "type": { "const": "zReport" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/ZReportParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "sellReceipt" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/ReceiptParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "refundReceipt" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/ReceiptParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "buyReceipt" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/ReceiptParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "returnBuyReceipt" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/ReceiptParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "sellCorrectionReceipt" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/CorrectionReceiptParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "refundSellCorrectionReceipt" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/CorrectionReceiptParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "buyCorrectionReceipt" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/CorrectionReceiptParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "refundBuyCorrectionReceipt" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/CorrectionReceiptParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "cashIn" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/CashInOutParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "cashOut" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/CashInOutParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "printNonFiscal" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/PrintNonFiscalParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "ofdExchangeStatus" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/OfdExchangeStatusParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "getDeviceInfo" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/EmptyParams" } } } },
    { "if": { "properties": { "type": { "const": "getDriverInfo" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/EmptyParams" } } } },
    { "if": { "properties": { "type": { "const": "getShiftTotals" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/GetShiftTotalsParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "getDepartmentSum" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/GetDepartmentSumParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "getFnInfo" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/EmptyParams" } } } },
    { "if": { "properties": { "type": { "const": "getFnDocument" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/GetFnDocumentParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "getFiscalDocumentResult" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/GetFiscalDocumentResultParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "reportFnRegistrations" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/ReportFnRegistrationsParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "beginMarkingCodeValidation" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/BeginMarkingCodeValidationParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "getMarkingCodeValidationStatus" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/GetMarkingCodeValidationStatusParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "cancelMarkingCodeValidation" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/CancelMarkingCodeValidationParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "checkImcWorkState" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/CheckImcWorkStateParams" } } } },
    { "if": { "properties": { "type": { "const": "pingIsmServer" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/PingIsmServerParams" } }, "required": ["params"] } },
    { "if": { "properties": { "type": { "const": "getIsmPingResult" } } }, "then": { "properties": { "params": { "$ref": "#/$defs/GetIsmPingResultParams" } } } }
  ],
  "$defs": {
    "EmptyParams": { "type": "object", "additionalProperties": false },
    "ContinuePrintParams": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "documentId": { "type": ["string", "integer"], "description": "Идентификатор документа для допечатки (если поддерживается)." },
        "repeat": { "type": "boolean", "default": false }
      }
    },
    "OpenShiftParams": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "cashier": { "$ref": "#/$defs/Person" },
        "operatorMessage": { "type": "string", "maxLength": 1024 }
      }
    },
    "CloseShiftParams": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "cashier": { "$ref": "#/$defs/Person" },
        "printReport": { "type": "boolean", "default": true }
      }
    },
    "ZReportParams": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "closeShift": { "type": "boolean", "default": true }
      }
    },

    "ReceiptParams": {
      "type": "object",
      "required": ["items", "payments"],
      "additionalProperties": false,
      "properties": {
        "taxSystem": { "$ref": "#/$defs/TaxSystem" },
        "items": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/ReceiptItem" } },
        "payments": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/Payment" } },
        "customerContact": { "type": "string", "description": "E-mail или телефон" },
        "cashier": { "$ref": "#/$defs/Person" },
        "additionalProps": { "type": "object", "additionalProperties": true, "description": "Прочие поддерживаемые вашей версией поля" }
      }
    },

    "CorrectionReceiptParams": {
      "type": "object",
      "required": ["items", "payments", "correction"],
      "additionalProperties": false,
      "properties": {
        "taxSystem": { "$ref": "#/$defs/TaxSystem" },
        "items": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/ReceiptItem" } },
        "payments": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/Payment" } },
        "correction": { "$ref": "#/$defs/CorrectionInfo" },
        "cashier": { "$ref": "#/$defs/Person" }
      }
    },

    "CashInOutParams": {
      "type": "object",
      "required": ["amount"],
      "additionalProperties": false,
      "properties": {
        "amount": { "$ref": "#/$defs/Amount" },
        "comment": { "type": "string" }
      }
    },

    "PrintNonFiscalParams": {
      "type": "object",
      "required": ["lines"],
      "additionalProperties": false,
      "properties": {
        "lines": { "type": "array", "minItems": 1, "items": { "type": "string", "maxLength": 1024 } }
      }
    },

    "OfdExchangeStatusParams": {
      "type": "object",
      "additionalProperties": false,
      "properties": { "detailed": { "type": "boolean", "default": false } }
    },

    "GetShiftTotalsParams": {
      "type": "object",
      "additionalProperties": false,
      "properties": { "includeReturns": { "type": "boolean", "default": true } }
    },

    "GetDepartmentSumParams": {
      "type": "object",
      "additionalProperties": false,
      "required": ["departmentId"],
      "properties": {
        "departmentId": { "type": "integer", "minimum": 0 },
        "includeNonFiscal": { "type": "boolean", "default": false }
      }
    },

    "GetFnDocumentParams": {
      "type": "object",
      "additionalProperties": false,
      "required": ["number"],
      "properties": {
        "number": { "type": "integer", "minimum": 1 },
        "withQr": { "type": "boolean", "description": "Возвратить реквизит 1196 (QR-код), если поддерживается" }
      }
    },

    "GetFiscalDocumentResultParams": {
      "type": "object",
      "additionalProperties": false,
      "required": ["number"],
      "properties": { "number": { "type": "integer", "minimum": 1 } }
    },

    "ReportFnRegistrationsParams": {
      "type": "object",
      "additionalProperties": false,
      "properties": { "print": { "type": "boolean", "default": true } }
    },

    "BeginMarkingCodeValidationParams": {
      "type": "object",
      "additionalProperties": false,
      "required": ["codes"],
      "properties": {
        "codes": { "type": "array", "minItems": 1, "items": { "type": "string", "minLength": 1 } },
        "notSendToServer": { "type": "boolean", "description": "Опция, упоминается в 10.9.5.0" },
        "waitForResult": { "type": "boolean", "description": "Ожидать ответ сервера маркировки в рамках задания" }
      }
    },

    "GetMarkingCodeValidationStatusParams": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "scope": { "type": "string", "enum": ["fn", "kkt"], "default": "kkt", "description": "Источник статуса: ФН или ККТ" },
        "detailed": { "type": "boolean", "default": true },
        "returnTimes": { "type": "boolean", "default": false, "description": "Вернуть времена проверки (если поддерживается)" }
      }
    },

    "CancelMarkingCodeValidationParams": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "all": { "type": "boolean", "default": true, "description": "Отменить все активные проверки" },
        "code": { "type": "string", "description": "Если требуется отменить проверку конкретного КМ" }
      }
    },

    "CheckImcWorkStateParams": { "type": "object", "additionalProperties": false },

    "PingIsmServerParams": { "type": "object", "additionalProperties": false },

    "GetIsmPingResultParams": { "type": "object", "additionalProperties": false },

    "ReceiptItem": {
      "type": "object",
      "required": ["name", "price", "quantity", "amount", "tax"],
      "additionalProperties": false,
      "properties": {
        "name": { "type": "string", "maxLength": 128 },
        "price": { "$ref": "#/$defs/Amount" },
        "quantity": { "type": "number", "exclusiveMinimum": 0 },
        "amount": { "$ref": "#/$defs/Amount", "description": "price*quantity" },
        "tax": { "$ref": "#/$defs/Tax" },
        "paymentMethod": { "$ref": "#/$defs/PaymentMethod" },
        "paymentObject": { "$ref": "#/$defs/PaymentObject" },
        "measurementUnit": { "$ref": "#/$defs/MeasurementUnit" },
        "barcode": { "type": "string" },
        "departmentId": { "type": "integer", "minimum": 0 },
        "nomenclatureCode": {
          "oneOf": [
            { "type": "string" },
            { "type": "object", "additionalProperties": false, "properties": { "type": { "type": "integer" }, "value": { "type": "string" } }, "required": ["type", "value"] }
          ],
          "description": "Код товарной номенклатуры/КМ"
        }
      }
    },

    "Payment": {
      "type": "object",
      "required": ["type", "amount"],
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["cash", "electron", "prepaid", "credit", "other"] },
        "amount": { "$ref": "#/$defs/Amount" }
      }
    },

    "CorrectionInfo": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "baseDate", "baseNumber"],
      "properties": {
        "type": { "type": "string", "enum": ["self", "instruction"] },
        "baseDate": { "type": "string", "format": "date" },
        "baseNumber": { "type": "string" },
        "description": { "type": "string" }
      }
    },

    "Person": {
      "type": "object",
      "additionalProperties": false,
      "properties": { "name": { "type": "string", "maxLength": 64 }, "inn": { "type": "string", "pattern": "^\\d{10}|\\d{12}$" } }
    },

    "Amount": { "type": "number", "minimum": 0, "multipleOf": 0.01 },

    "Tax": { "type": "string", "enum": ["none", "vat0", "vat10", "vat20", "vat110", "vat120"] },

    "TaxSystem": { "type": "string", "enum": ["osn", "usn_income", "usn_income_outcome", "envd", "esn", "patent"] },

    "PaymentMethod": { "type": "string", "enum": ["full_prepayment", "prepayment", "advance", "full_payment", "partial_payment", "credit", "credit_payment"] },

    "PaymentObject": { "type": "string", "enum": [
      "commodity", "excise", "job", "service", "gambling_bet", "gambling_prize", "lottery", "lottery_prize", "intellectual_activity", "payment", "agent_commission", "composite", "another",
      "property_right", "non_operating_gain", "insurance_premium", "sales_tax", "resort_fee", "deposit", "expense", "pension_insurance_ip", "pension_insurance", "medical_insurance_ip", "medical_insurance", "social_insurance"
    ] },

    "MeasurementUnit": { "type": "string", "enum": ["piece", "gram", "kg", "ton", "cm", "m", "km", "ml", "l", "m3", "s", "min", "h", "day", "month", "year", "kwh", "gkal", "point", "pack", "other"] }
  }
}
